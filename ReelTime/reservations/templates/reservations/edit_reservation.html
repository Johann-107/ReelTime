{% extends 'reel_time/partials/base.html' %}
{% load static %}

{% block title %}Edit Reservation - ReelTime{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/reserve_movie.css' %}">
<style>
    .page-content {
        padding: 2rem 0;
        min-height: calc(100vh - 200px);
    }

    .edit-reservation-card {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-bottom: none;
    }

    .card-header h4 {
        margin: 0;
        font-size: 1.75rem;
        font-weight: 600;
    }

    .card-body {
        padding: 2rem;
    }

    .reservation-info {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
    }

    .reservation-info h5 {
        color: #333;
        font-size: 1.5rem;
        margin-bottom: 0.75rem;
    }

    .reservation-info p {
        margin-bottom: 0.5rem;
        color: #666;
        font-size: 1rem;
    }

    .cost-display-section {
        background: #f0f4ff;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
    }

    .cost-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .cost-item:last-child {
        margin-bottom: 0;
        padding-top: 0.75rem;
        border-top: 2px solid #667eea;
    }

    .cost-label {
        font-weight: 500;
        color: #555;
    }

    .cost-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: #667eea;
    }

    .total-cost .cost-value {
        font-size: 1.5rem;
        color: #764ba2;
    }

    .selected-seats-display {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 6px;
        padding: 1rem;
        margin-top: 1rem;
        color: #856404;
        font-weight: 500;
    }

    .alert {
        padding: 1rem;
        border-radius: 6px;
        margin-bottom: 1.5rem;
    }

    .alert-danger, .alert-error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }

    .alert-success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }

    .btn-group {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
    }

    .btn {
        padding: 0.75rem 2rem;
        border: none;
        border-radius: 6px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-outline-secondary {
        background: white;
        color: #666;
        border: 2px solid #ddd;
    }

    .btn-outline-secondary:hover {
        background: #f8f9fa;
        border-color: #999;
    }

    .form-label {
        display: block;
        margin-bottom: 0.75rem;
        font-weight: 600;
        color: #333;
        font-size: 1.1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-content">
    <div class="container">
        <div class="edit-reservation-card">
            <div class="card-header">
                <h4>Edit Reservation</h4>
            </div>
            <div class="card-body">
                <div class="reservation-info">
                    <h5>{{ reservation.movie_detail.movie.title }}</h5>
                    <p>
                        <strong>Cinema:</strong> {{ reservation.cinema_name }}
                    </p>
                    <p>
                        <strong>Date:</strong> {{ reservation.selected_date|date:"M d, Y" }} â€¢ 
                        <strong>Time:</strong> {{ reservation.selected_showtime }}
                    </p>
                    <p>
                        <strong>Current Seats:</strong> {{ reservation.number_of_seats }} seat(s)
                    </p>
                    <p>
                        <strong>Current Total:</strong> ${{ reservation.total_cost }}
                    </p>
                </div>

                <form method="post" id="editReservationForm">
                    {% csrf_token %}

                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}

                    <div class="cost-display-section">
                        <div class="cost-item">
                            <span class="cost-label">Price per Seat:</span>
                            <span class="cost-value" id="pricePerSeat">${{ reservation.movie_detail.price }}</span>
                        </div>
                        <div class="cost-item total-cost">
                            <span class="cost-label">New Total Cost:</span>
                            <span class="cost-value" id="newTotalCost">${{ reservation.total_cost }}</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Select Your Seats (Maximum: {{ reservation.number_of_seats }} seat{{ reservation.number_of_seats|pluralize }})</label>
                        <p style="color: #666; margin-bottom: 1rem;">
                            Click on seats to select or deselect them. You originally reserved <strong>{{ reservation.number_of_seats }}</strong> seat{{ reservation.number_of_seats|pluralize }}.
                            You can select the same number or fewer seats.
                        </p>
                        <div id="seatLayoutContainer" class="seat-layout"></div>
                        <input type="hidden" id="selectedSeatsInput" name="selected_seats" value='{{ current_selected_seats|safe }}'>
                        <input type="hidden" id="maxSeats" value="{{ reservation.number_of_seats }}">
                    </div>

                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">Update Reservation</button>
                        <a href="{% url 'reservations' %}" class="btn btn-outline-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const seatLayoutContainer = document.getElementById('seatLayoutContainer');
    const selectedSeatsInput = document.getElementById('selectedSeatsInput');
    const newTotalCostElement = document.getElementById('newTotalCost');
    const pricePerSeat = {{ reservation.movie_detail.price }};
    const maxSeats = parseInt(document.getElementById('maxSeats').value);
    
    // Parse data from Django
    const seatMapData = {{ seat_map|safe }};
    const reservedSeats = {{ reserved_seats|safe }};
    let selectedSeats = {{ current_selected_seats|safe }};

    console.log('Seat Map:', seatMapData);
    console.log('Reserved Seats:', reservedSeats);
    console.log('Current Selected Seats:', selectedSeats);
    console.log('Max Seats Allowed:', maxSeats);

    function updateTotalCost() {
        const total = selectedSeats.length * pricePerSeat;
        newTotalCostElement.textContent = `$${total.toFixed(2)}`;
    }

    function renderSeatLayout(seatMapArray, reservedSeatsArray, currentSelectedSeats) {
        seatLayoutContainer.innerHTML = '';

        if (!seatMapArray || seatMapArray.length === 0) {
            seatLayoutContainer.innerHTML = '<p class="no-seats">No seat layout available.</p>';
            return;
        }

        // Find the minimum and maximum row and column for actual seats
        const seatRows = seatMapArray.filter(seat => seat.type === 'seat').map(seat => seat.row);
        const seatCols = seatMapArray.filter(seat => seat.type === 'seat').map(seat => seat.col);
        
        const minSeatRow = Math.min(...seatRows);
        const maxSeatRow = Math.max(...seatRows);

        // Find overall max row and col
        const maxRow = Math.max(...seatMapArray.map(seat => seat.row));
        const maxCol = Math.max(...seatMapArray.map(seat => seat.col));

        // Create a 2D matrix
        const matrix = [];
        for (let r = 0; r <= maxRow; r++) {
            const row = [];
            for (let c = 0; c <= maxCol; c++) {
                const seat = seatMapArray.find(s => s.row === r && s.col === c);
                row.push(seat || { type: 'empty', row: r, col: c });
            }
            matrix.push(row);
        }

        // Add screen
        const screen = document.createElement('div');
        screen.className = 'screen';
        screen.textContent = 'SCREEN';
        seatLayoutContainer.appendChild(screen);

        // Pre-calculate seat numbering (right to left)
        const rowSeatNumbers = {};
        matrix.forEach((rowArr, rowIndex) => {
            const seatColumns = rowArr
                .map((seat, colIndex) => ({ seat, colIndex }))
                .filter(({ seat }) => seat.type === 'seat')
                .sort((a, b) => b.colIndex - a.colIndex);
            
            rowSeatNumbers[rowIndex] = {};
            seatColumns.forEach(({ seat, colIndex }, index) => {
                rowSeatNumbers[rowIndex][colIndex] = index + 1;
            });
        });

        // Render the grid
        matrix.forEach((rowArr, rowIndex) => {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'seat-row';

            rowArr.forEach((seat, colIndex) => {
                if (seat.type === 'screen') return;

                const seatId = `${seat.row}-${seat.col}`;
                const seatBtn = document.createElement('button');
                seatBtn.type = 'button';
                seatBtn.className = 'seat';
                seatBtn.dataset.seatId = seatId;

                let seatLabel = '';
                if (seat.type === 'seat') {
                    const adjustedRowIndex = rowIndex - minSeatRow;
                    const seatNumber = rowSeatNumbers[rowIndex][colIndex];
                    seatLabel = `${String.fromCharCode(65 + adjustedRowIndex)}${seatNumber}`;
                } else if (seat.type === 'entrance') {
                    seatLabel = 'ðŸšª>';
                } else if (seat.type === 'exit') {
                    seatLabel = 'ðŸšª<';
                }

                seatBtn.textContent = seatLabel;

                // Apply styles
                if (seat.type === 'seat') {
                    seatBtn.classList.add('seat-available');
                    
                    if (reservedSeatsArray.includes(seatId)) {
                        seatBtn.classList.remove('seat-available');
                        seatBtn.classList.add('seat-reserved');
                        seatBtn.disabled = true;
                    } else if (currentSelectedSeats.includes(seatId)) {
                        seatBtn.classList.add('seat-selected');
                    }
                } else if (seat.type === 'entrance' || seat.type === 'exit') {
                    seatBtn.classList.add('seat-entrance-exit');
                    seatBtn.disabled = true;
                } else {
                    seatBtn.classList.add('seat-empty');
                    seatBtn.disabled = true;
                }

                // Click event for available seats
                if (seat.type === 'seat' && !reservedSeatsArray.includes(seatId)) {
                    seatBtn.addEventListener('click', function() {
                        if (seatBtn.classList.contains('seat-selected')) {
                            seatBtn.classList.remove('seat-selected');
                            selectedSeats = selectedSeats.filter(s => s !== seatId);
                        } else {
                            // Check if max seats reached
                            if (selectedSeats.length >= maxSeats) {
                                alert(`You can only select up to ${maxSeats} seat(s). This is the number you originally reserved.`);
                                return;
                            }
                            seatBtn.classList.add('seat-selected');
                            selectedSeats.push(seatId);
                        }
                        selectedSeatsInput.value = JSON.stringify(selectedSeats);
                        updateSelectedSeatsDisplay(selectedSeats, minSeatRow, rowSeatNumbers);
                        updateTotalCost();
                    });
                }

                rowDiv.appendChild(seatBtn);
            });

            seatLayoutContainer.appendChild(rowDiv);
        });

        addSeatLegend();
        updateSelectedSeatsDisplay(selectedSeats, minSeatRow, rowSeatNumbers);
        updateTotalCost();
    }

    function addSeatLegend() {
        const legend = document.createElement('div');
        legend.className = 'seat-legend';
        legend.innerHTML = `
            <div class="legend-item">
                <span class="seat-sample seat-available"></span>
                <span>Available</span>
            </div>
            <div class="legend-item">
                <span class="seat-sample seat-selected"></span>
                <span>Selected</span>
            </div>
            <div class="legend-item">
                <span class="seat-sample seat-reserved"></span>
                <span>Reserved</span>
            </div>
            <div class="legend-item">
                <span class="seat-sample seat-entrance-exit">ðŸšª</span>
                <span>Entrance/Exit</span>
            </div>
        `;
        seatLayoutContainer.appendChild(legend);
    }

    function updateSelectedSeatsDisplay(selectedSeats, minSeatRow, rowSeatNumbers) {
        let display = document.getElementById('selectedSeatsDisplay');
        if (!display) {
            display = document.createElement('div');
            display.id = 'selectedSeatsDisplay';
            display.className = 'selected-seats-display';
            seatLayoutContainer.parentNode.insertBefore(display, seatLayoutContainer.nextSibling);
        }
        
        if (selectedSeats.length > 0) {
            const seatLabels = selectedSeats.map(seatId => {
                const [row, col] = seatId.split('-').map(Number);
                const adjustedRowIndex = row - minSeatRow;
                const seatNumber = rowSeatNumbers[row] ? rowSeatNumbers[row][col] : 0;
                return `${String.fromCharCode(65 + adjustedRowIndex)}${seatNumber}`;
            });
            display.textContent = `Selected Seats: ${seatLabels.join(', ')} (${selectedSeats.length} seat${selectedSeats.length !== 1 ? 's' : ''})`;
        } else {
            display.textContent = 'No seats selected. Please select at least one seat.';
        }
    }

    // Form validation
    document.getElementById('editReservationForm').addEventListener('submit', function(e) {
        if (selectedSeats.length === 0) {
            e.preventDefault();
            alert('Please select at least one seat before updating your reservation.');
            return false;
        }
    });

    // Initialize
    renderSeatLayout(seatMapData, reservedSeats, selectedSeats);
});
</script>
{% endblock %}