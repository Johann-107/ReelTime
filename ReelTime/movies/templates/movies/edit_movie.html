{% extends 'reel_time/partials/base.html' %}
{% load static %}

{% block title %}Edit Movie - ReelTime{% endblock title %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/edit_movie.css' %}">
{% endblock extra_head %}

{% block content %}
<div class="page-content">
    <div class="container">
        <div class="edit-movie-container">
            <h2>Edit Movie: {{ detail.movie.title }}</h2>

            <form method="POST" enctype="multipart/form-data">
                {% csrf_token %}

                <fieldset>
                    <legend>General Information</legend>
                    {# Only show movie-related fields, excluding admin-related ones #}
                    {{ movie_form.title.errors }}
                    <p>{{ movie_form.title.label_tag }} {{ movie_form.title }}</p>

                    {{ movie_form.description.errors }}
                    <p>{{ movie_form.description.label_tag }} {{ movie_form.description }}</p>

                    {{ movie_form.genre.errors }}
                    <p>{{ movie_form.genre.label_tag }} {{ movie_form.genre }}</p>

                    {{ movie_form.director.errors }}
                    <p>{{ movie_form.director.label_tag }} {{ movie_form.director }}</p>

                    {{ movie_form.duration_minutes.errors }}
                    <p>{{ movie_form.duration_minutes.label_tag }} {{ movie_form.duration_minutes }}</p>

                    {{ movie_form.rating.errors }}
                    <p>{{ movie_form.rating.label_tag }} {{ movie_form.rating }}</p>
                </fieldset>

                <fieldset>
                    <legend>Admin Details</legend>
                    
                    {{ detail_form.release_date.errors }}
                    <p>{{ detail_form.release_date.label_tag }} {{ detail_form.release_date }}</p>

                    {{ detail_form.end_date.errors }}
                    <p>{{ detail_form.end_date.label_tag }} {{ detail_form.end_date }}</p>

                    {{ detail_form.hall.errors }}
                    <p>{{ detail_form.hall.label_tag }} {{ detail_form.hall }}</p>

                    {{ detail_form.price.errors }}
                    <p>{{ detail_form.price.label_tag }} {{ detail_form.price }}</p>

                    {{ detail_form.showing_times.errors }}
                    <p>{{ detail_form.showing_times.label_tag }} {{ detail_form.showing_times }}</p>

                    {# Poster Upload with Preview #}
                    <div class="poster-upload-section">
                        <label>Current Poster:</label>
                        <div class="poster-preview-container">
                            {% if detail.poster %}
                                <img src="{{ detail.poster.url }}" alt="Movie Poster" id="poster-preview" class="poster-preview">
                            {% else %}
                                <div class="poster-placeholder" id="poster-preview">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                        <polyline points="21 15 16 10 5 21"></polyline>
                                    </svg>
                                    <p>No poster uploaded</p>
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="poster-controls">
                            {{ detail_form.poster.errors }}
                            <div class="form-group">
                                <label for="{{ detail_form.poster.id_for_label }}">Upload New Poster:</label>
                                <input type="file" name="poster" id="{{ detail_form.poster.id_for_label }}" accept="image/*">
                                <small class="help-text">Upload a movie poster (JPG, PNG)</small>
                            </div>
                            <button type="button" id="clear-poster-btn" class="btn-clear-poster">Clear Poster</button>
                            <input type="hidden" name="clear_poster" id="clear-poster-flag" value="false">
                        </div>
                    </div>
                </fieldset>

                <button type="submit" class="btn btn-success">Save Changes</button>
                <a href="{% url 'movie_list' %}" class="btn btn-secondary">Cancel</a>
            </form>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
    // Poster preview functionality
    const posterInput = document.querySelector('input[name="poster"]');
    const posterPreview = document.getElementById('poster-preview');
    const clearPosterBtn = document.getElementById('clear-poster-btn');
    const clearPosterFlag = document.getElementById('clear-poster-flag');

    // Preview uploaded image
    if (posterInput) {
        posterInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    // If preview is an image, update it
                    if (posterPreview.tagName === 'IMG') {
                        posterPreview.src = event.target.result;
                    } else {
                        // Replace placeholder with image
                        const img = document.createElement('img');
                        img.src = event.target.result;
                        img.alt = 'Movie Poster Preview';
                        img.id = 'poster-preview';
                        img.className = 'poster-preview';
                        posterPreview.parentNode.replaceChild(img, posterPreview);
                    }
                    clearPosterFlag.value = 'false';
                };
                reader.readAsDataURL(file);
            }
        });
    }

    // Clear poster functionality
    if (clearPosterBtn) {
        clearPosterBtn.addEventListener('click', function() {
            // Clear file input
            if (posterInput) {
                posterInput.value = '';
            }

            // Replace image with placeholder
            const currentPreview = document.getElementById('poster-preview');
            if (currentPreview) {
                const placeholder = document.createElement('div');
                placeholder.className = 'poster-placeholder';
                placeholder.id = 'poster-preview';
                placeholder.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline>
                    </svg>
                    <p>No poster uploaded</p>
                `;
                currentPreview.parentNode.replaceChild(placeholder, currentPreview);
            }

            // Set flag to clear poster on save
            clearPosterFlag.value = 'true';
        });
    }
</script>
{% endblock extra_js %}